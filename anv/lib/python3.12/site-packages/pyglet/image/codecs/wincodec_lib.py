"""Windows Imaging Component library definitions for Windows OS."""

from ctypes import byref, c_void_p, memmove

from pyglet.image import ImageData
from pyglet.image.codecs import ImageDecodeException, ImageDecoder, ImageEncoder, os
from pyglet.libs.win32 import _kernel32 as kernel32
from pyglet.libs.win32 import _ole32 as ole32
from pyglet.libs.win32 import com
from pyglet.libs.win32.constants import (
    CLSCTX_INPROC_SERVER,
    GENERIC_WRITE,
    GMEM_MOVEABLE,
    STREAM_SEEK_SET,
    WINDOWS_8_OR_GREATER,
)
from pyglet.libs.win32.types import (
    BOOL,
    BYTE,
    DOUBLE,
    DWORD,
    LPCWSTR,
    POINTER,
    PROPVARIANT,
    STATSTG,
    UINT,
    ULONG,
    IStream,
)

CLSID_WICImagingFactory1 = com.GUID(
    0xCACAF262, 0x9370, 0x4615, 0xA1, 0x3B, 0x9F, 0x55, 0x39, 0xDA, 0x4C, 0xA
)
CLSID_WICImagingFactory2 = com.GUID(
    0x317D06E8, 0x5F24, 0x433D, 0xBD, 0xF7, 0x79, 0xCE, 0x68, 0xD8, 0xAB, 0xC2
)


WICBitmapCreateCacheOption = UINT
WICBitmapNoCache = 0
WICBitmapCacheOnDemand = 0x1
WICBitmapCacheOnLoad = 0x2
WICBITMAPCREATECACHEOPTION_FORCE_DWORD = 0x7FFFFFFF

WICBitmapPaletteType = UINT
WICBitmapPaletteTypeCustom = 0

WICBitmapTransformOptions = UINT
WICBitmapTransformRotate0 = 0
WICBitmapTransformRotate90 = 0x1
WICBitmapTransformRotate180 = 0x2
WICBitmapTransformRotate270 = 0x3
WICBitmapTransformFlipHorizontal = 0x8
WICBitmapTransformFlipVertical = 0x10

WICBitmapDitherType = UINT
WICBitmapDitherTypeNone = 0
WICBitmapDitherTypeSolid = 0
WICBitmapDitherTypeOrdered4x4 = 0x1
WICBitmapDitherTypeOrdered8x8 = 0x2
WICBitmapDitherTypeOrdered16x16 = 0x3
WICBitmapDitherTypeSpiral4x4 = 0x4
WICBitmapDitherTypeSpiral8x8 = 0x5
WICBitmapDitherTypeDualSpiral4x4 = 0x6
WICBitmapDitherTypeDualSpiral8x8 = 0x7
WICBitmapDitherTypeErrorDiffusion = 0x8
WICBITMAPDITHERTYPE_FORCE_DWORD = 0x7FFFFFFF
WICBITMAPTRANSFORMOPTIONS_FORCE_DWORD = 0x7FFFFFFF

WICDecodeOptions = UINT
WICDecodeMetadataCacheOnDemand = 0
WICDecodeMetadataCacheOnLoad = 0x1
WICMETADATACACHEOPTION_FORCE_DWORD = 0x7FFFFFFF

WICBitmapEncoderCacheOption = UINT
WICBitmapEncoderCacheInMemory = 0x0
WICBitmapEncoderCacheTempFile = 0x1
WICBitmapEncoderNoCache = 0x2
WICBITMAPENCODERCACHEOPTION_FORCE_DWORD = 0x7FFFFFFF

# Different pixel formats.
REFWICPixelFormatGUID = POINTER(com.GUID)
GUID_WICPixelFormatDontCare = com.GUID(
    0x6FDDC324, 0x4E03, 0x4BFE, 0xB1, 0x85, 0x3D, 0x77, 0x76, 0x8D, 0xC9, 0x00
)
GUID_WICPixelFormat1bppIndexed = com.GUID(
    0x6FDDC324, 0x4E03, 0x4BFE, 0xB1, 0x85, 0x3D, 0x77, 0x76, 0x8D, 0xC9, 0x01
)
GUID_WICPixelFormat2bppIndexed = com.GUID(
    0x6FDDC324, 0x4E03, 0x4BFE, 0xB1, 0x85, 0x3D, 0x77, 0x76, 0x8D, 0xC9, 0x02
)
GUID_WICPixelFormat4bppIndexed = com.GUID(
    0x6FDDC324, 0x4E03, 0x4BFE, 0xB1, 0x85, 0x3D, 0x77, 0x76, 0x8D, 0xC9, 0x03
)
GUID_WICPixelFormat8bppIndexed = com.GUID(
    0x6FDDC324, 0x4E03, 0x4BFE, 0xB1, 0x85, 0x3D, 0x77, 0x76, 0x8D, 0xC9, 0x04
)
GUID_WICPixelFormatBlackWhite = com.GUID(
    0x6FDDC324, 0x4E03, 0x4BFE, 0xB1, 0x85, 0x3D, 0x77, 0x76, 0x8D, 0xC9, 0x05
)
GUID_WICPixelFormat2bppGray = com.GUID(
    0x6FDDC324, 0x4E03, 0x4BFE, 0xB1, 0x85, 0x3D, 0x77, 0x76, 0x8D, 0xC9, 0x06
)
GUID_WICPixelFormat4bppGray = com.GUID(
    0x6FDDC324, 0x4E03, 0x4BFE, 0xB1, 0x85, 0x3D, 0x77, 0x76, 0x8D, 0xC9, 0x07
)
GUID_WICPixelFormat8bppGray = com.GUID(
    0x6FDDC324, 0x4E03, 0x4BFE, 0xB1, 0x85, 0x3D, 0x77, 0x76, 0x8D, 0xC9, 0x08
)
GUID_WICPixelFormat8bppAlpha = com.GUID(
    0xE6CD0116, 0xEEBA, 0x4161, 0xAA, 0x85, 0x27, 0xDD, 0x9F, 0xB3, 0xA8, 0x95
)
GUID_WICPixelFormat16bppBGR555 = com.GUID(
    0x6FDDC324, 0x4E03, 0x4BFE, 0xB1, 0x85, 0x3D, 0x77, 0x76, 0x8D, 0xC9, 0x09
)
GUID_WICPixelFormat16bppBGR565 = com.GUID(
    0x6FDDC324, 0x4E03, 0x4BFE, 0xB1, 0x85, 0x3D, 0x77, 0x76, 0x8D, 0xC9, 0x0A
)
GUID_WICPixelFormat16bppBGRA5551 = com.GUID(
    0x05EC7C2B, 0xF1E6, 0x4961, 0xAD, 0x46, 0xE1, 0xCC, 0x81, 0x0A, 0x87, 0xD2
)
GUID_WICPixelFormat16bppGray = com.GUID(
    0x6FDDC324, 0x4E03, 0x4BFE, 0xB1, 0x85, 0x3D, 0x77, 0x76, 0x8D, 0xC9, 0x0B
)
GUID_WICPixelFormat24bppBGR = com.GUID(
    0x6FDDC324, 0x4E03, 0x4BFE, 0xB1, 0x85, 0x3D, 0x77, 0x76, 0x8D, 0xC9, 0x0C
)
GUID_WICPixelFormat24bppRGB = com.GUID(
    0x6FDDC324, 0x4E03, 0x4BFE, 0xB1, 0x85, 0x3D, 0x77, 0x76, 0x8D, 0xC9, 0x0D
)
GUID_WICPixelFormat32bppBGR = com.GUID(
    0x6FDDC324, 0x4E03, 0x4BFE, 0xB1, 0x85, 0x3D, 0x77, 0x76, 0x8D, 0xC9, 0x0E
)
GUID_WICPixelFormat32bppBGRA = com.GUID(
    0x6FDDC324, 0x4E03, 0x4BFE, 0xB1, 0x85, 0x3D, 0x77, 0x76, 0x8D, 0xC9, 0x0F
)
GUID_WICPixelFormat32bppPBGRA = com.GUID(
    0x6FDDC324, 0x4E03, 0x4BFE, 0xB1, 0x85, 0x3D, 0x77, 0x76, 0x8D, 0xC9, 0x10
)
GUID_WICPixelFormat32bppRGB = com.GUID(
    0xD98C6B95, 0x3EFE, 0x47D6, 0xBB, 0x25, 0xEB, 0x17, 0x48, 0xAB, 0x0C, 0xF1
)  # 7 platform update?
GUID_WICPixelFormat32bppRGBA = com.GUID(
    0xF5C7AD2D, 0x6A8D, 0x43DD, 0xA7, 0xA8, 0xA2, 0x99, 0x35, 0x26, 0x1A, 0xE9
)
GUID_WICPixelFormat32bppPRGBA = com.GUID(
    0x3CC4A650, 0xA527, 0x4D37, 0xA9, 0x16, 0x31, 0x42, 0xC7, 0xEB, 0xED, 0xBA
)
GUID_WICPixelFormat48bppRGB = com.GUID(
    0x6FDDC324, 0x4E03, 0x4BFE, 0xB1, 0x85, 0x3D, 0x77, 0x76, 0x8D, 0xC9, 0x15
)
GUID_WICPixelFormat48bppBGR = com.GUID(
    0xE605A384, 0xB468, 0x46CE, 0xBB, 0x2E, 0x36, 0xF1, 0x80, 0xE6, 0x43, 0x13
)

GUID_ContainerFormatBmp = com.GUID(
    0x0AF1D87E, 0xFCFE, 0x4188, 0xBD, 0xEB, 0xA7, 0x90, 0x64, 0x71, 0xCB, 0xE3
)
GUID_ContainerFormatPng = com.GUID(
    0x1B7CFAF4, 0x713F, 0x473C, 0xBB, 0xCD, 0x61, 0x37, 0x42, 0x5F, 0xAE, 0xAF
)
GUID_ContainerFormatIco = com.GUID(
    0xA3A860C4, 0x338F, 0x4C17, 0x91, 0x9A, 0xFB, 0xA4, 0xB5, 0x62, 0x8F, 0x21
)
GUID_ContainerFormatJpeg = com.GUID(
    0x19E4A5AA, 0x5662, 0x4FC5, 0xA0, 0xC0, 0x17, 0x58, 0x02, 0x8E, 0x10, 0x57
)
GUID_ContainerFormatTiff = com.GUID(
    0x163BCC30, 0xE2E9, 0x4F0B, 0x96, 0x1D, 0xA3, 0xE9, 0xFD, 0xB7, 0x88, 0xA3
)
GUID_ContainerFormatGif = com.GUID(
    0x1F8A5601, 0x7D4D, 0x4CBD, 0x9C, 0x82, 0x1B, 0xC8, 0xD4, 0xEE, 0xB9, 0xA5
)
GUID_ContainerFormatWmp = com.GUID(
    0x57A37CAA, 0x367A, 0x4540, 0x91, 0x6B, 0xF1, 0x83, 0xC5, 0x09, 0x3A, 0x4B
)


class IPropertyBag2(com.pIUnknown):
    _methods_ = [
        ("Read", com.STDMETHOD()),
        ("Write", com.STDMETHOD()),
        ("CountProperties", com.STDMETHOD()),
        ("GetPropertyInfo", com.STDMETHOD()),
        ("LoadObject", com.STDMETHOD()),
    ]


class IWICPalette(com.pIUnknown):
    _methods_ = [
        ("InitializePredefined", com.STDMETHOD()),
        ("InitializeCustom", com.STDMETHOD()),
        ("InitializeFromBitmap", com.STDMETHOD()),
        ("InitializeFromPalette", com.STDMETHOD()),
        ("GetType", com.STDMETHOD()),
        ("GetColorCount", com.STDMETHOD()),
        ("GetColors", com.STDMETHOD()),
        ("IsBlackWhite", com.STDMETHOD()),
        ("IsGrayscale", com.STDMETHOD()),
        ("HasAlpha", com.STDMETHOD()),
    ]


class IWICStream(IStream, com.pIUnknown):
    _methods_ = [
        ("InitializeFromIStream", com.STDMETHOD(IStream)),
        ("InitializeFromFilename", com.STDMETHOD(LPCWSTR, DWORD)),
        ("InitializeFromMemory", com.STDMETHOD(POINTER(BYTE), DWORD)),
        ("InitializeFromIStreamRegion", com.STDMETHOD()),
    ]


class IWICBitmapFrameEncode(com.pIUnknown):
    _methods_ = [
        ("Initialize", com.STDMETHOD(IPropertyBag2)),
        ("SetSize", com.STDMETHOD(UINT, UINT)),
        ("SetResolution", com.STDMETHOD()),
        ("SetPixelFormat", com.STDMETHOD(REFWICPixelFormatGUID)),
        ("SetColorContexts", com.STDMETHOD()),
        ("SetPalette", com.STDMETHOD(IWICPalette)),
        ("SetThumbnail", com.STDMETHOD()),
        ("WritePixels", com.STDMETHOD(UINT, UINT, UINT, POINTER(BYTE))),
        ("WriteSource", com.STDMETHOD()),
        ("Commit", com.STDMETHOD()),
        ("GetMetadataQueryWriter", com.STDMETHOD()),
    ]


class IWICBitmapEncoder(com.pIUnknown):
    _methods_ = [
        ("Initialize", com.STDMETHOD(IWICStream, WICBitmapEncoderCacheOption)),
        ("GetContainerFormat", com.STDMETHOD()),
        ("GetEncoderInfo", com.STDMETHOD()),
        ("SetColorContexts", com.STDMETHOD()),
        ("SetPalette", com.STDMETHOD()),
        ("SetThumbnail", com.STDMETHOD()),
        ("SetPreview", com.STDMETHOD()),
        (
            "CreateNewFrame",
            com.STDMETHOD(POINTER(IWICBitmapFrameEncode), POINTER(IPropertyBag2)),
        ),
        ("Commit", com.STDMETHOD()),
        ("GetMetadataQueryWriter", com.STDMETHOD()),
    ]


class IWICComponentInfo(com.pIUnknown):
    _methods_ = [
        ("GetComponentType", com.STDMETHOD()),
        ("GetCLSID", com.STDMETHOD()),
        ("GetSigningStatus", com.STDMETHOD()),
        ("GetAuthor", com.STDMETHOD()),
        ("GetVendorGUID", com.STDMETHOD()),
        ("GetVersion", com.STDMETHOD()),
        ("GetSpecVersion", com.STDMETHOD()),
        ("GetFriendlyName", com.STDMETHOD()),
    ]


class IWICPixelFormatInfo(IWICComponentInfo, com.pIUnknown):
    _methods_ = [
        ("GetFormatGUID", com.STDMETHOD(POINTER(com.GUID))),
        ("GetColorContext", com.STDMETHOD()),
        ("GetBitsPerPixel", com.STDMETHOD(POINTER(UINT))),
        ("GetChannelCount", com.STDMETHOD(POINTER(UINT))),
        ("GetChannelMask", com.STDMETHOD()),
    ]


class IWICBitmapSource(com.pIUnknown):
    _methods_ = [
        ("GetSize", com.STDMETHOD(POINTER(UINT), POINTER(UINT))),
        ("GetPixelFormat", com.STDMETHOD(REFWICPixelFormatGUID)),
        ("GetResolution", com.STDMETHOD(POINTER(DOUBLE), POINTER(DOUBLE))),
        ("CopyPalette", com.STDMETHOD()),
        ("CopyPixels", com.STDMETHOD(c_void_p, UINT, UINT, c_void_p)),
    ]


class IWICFormatConverter(IWICBitmapSource, com.pIUnknown):
    _methods_ = [
        (
            "Initialize",
            com.STDMETHOD(
                IWICBitmapSource,
                REFWICPixelFormatGUID,
                WICBitmapDitherType,
                c_void_p,
                DOUBLE,
                WICBitmapPaletteType,
            ),
        ),
        (
            "CanConvert",
            com.STDMETHOD(REFWICPixelFormatGUID, REFWICPixelFormatGUID, POINTER(BOOL)),
        ),
    ]


class IWICMetadataQueryReader(com.pIUnknown):
    _methods_ = [
        ("GetContainerFormat", com.STDMETHOD()),
        ("GetLocation", com.STDMETHOD()),
        ("GetMetadataByName", com.STDMETHOD(LPCWSTR, c_void_p)),
        ("GetEnumerator", com.STDMETHOD()),
    ]


class IWICBitmapFrameDecode(IWICBitmapSource, com.pIUnknown):
    _methods_ = [
        ("GetMetadataQueryReader", com.STDMETHOD(POINTER(IWICMetadataQueryReader))),
        ("GetColorContexts", com.STDMETHOD()),
        ("GetThumbnail", com.STDMETHOD(POINTER(IWICBitmapSource))),
    ]


class IWICBitmapFlipRotator(IWICBitmapSource, com.pIUnknown):
    _methods_ = [
        ("Initialize", com.STDMETHOD(IWICBitmapSource, WICBitmapTransformOptions)),
    ]


class IWICBitmap(IWICBitmapSource, com.pIUnknown):
    _methods_ = [
        ("Lock", com.STDMETHOD()),
        ("SetPalette", com.STDMETHOD()),
        ("SetResolution", com.STDMETHOD()),
    ]


class IWICBitmapDecoder(com.pIUnknown):
    _methods_ = [
        ("QueryCapability", com.STDMETHOD()),
        ("Initialize", com.STDMETHOD()),
        ("GetContainerFormat", com.STDMETHOD()),
        ("GetDecoderInfo", com.STDMETHOD()),
        ("CopyPalette", com.STDMETHOD()),
        ("GetMetadataQueryReader", com.STDMETHOD(POINTER(IWICMetadataQueryReader))),
        ("GetPreview", com.STDMETHOD()),
        ("GetColorContexts", com.STDMETHOD()),
        ("GetThumbnail", com.STDMETHOD()),
        ("GetFrameCount", com.STDMETHOD(POINTER(UINT))),
        ("GetFrame", com.STDMETHOD(UINT, POINTER(IWICBitmapFrameDecode))),
    ]


IID_IWICImagingFactory1 = com.GUID(
    0xEC5EC8A9, 0xC395, 0x4314, 0x9C, 0x77, 0x54, 0xD7, 0xA9, 0x35, 0xFF, 0x70
)
IID_IWICImagingFactory2 = com.GUID(
    0x7B816B45, 0x1996, 0x4476, 0xB1, 0x32, 0xDE, 0x9E, 0x24, 0x7C, 0x8A, 0xF0
)


IID_IWICPixelFormatInfo = com.GUID(
    0xE8EDA601, 0x3D48, 0x431A, 0xAB, 0x44, 0x69, 0x05, 0x9B, 0xE8, 0x8B, 0xBE
)


class IWICImagingFactory(com.pIUnknown):
    _methods_ = [
        (
            "CreateDecoderFromFilename",
            com.STDMETHOD(
                LPCWSTR, com.GUID, DWORD, WICDecodeOptions, POINTER(IWICBitmapDecoder)
            ),
        ),
        (
            "CreateDecoderFromStream",
            com.STDMETHOD(
                com.pIUnknown, c_void_p, WICDecodeOptions, POINTER(IWICBitmapDecoder)
            ),
        ),
        ("CreateDecoderFromFileHandle", com.STDMETHOD()),
        ("CreateComponentInfo", com.STDMETHOD(com.GUID, POINTER(IWICComponentInfo))),
        ("CreateDecoder", com.STDMETHOD()),
        (
            "CreateEncoder",
            com.STDMETHOD(
                POINTER(com.GUID), POINTER(com.GUID), POINTER(IWICBitmapEncoder)
            ),
        ),
        ("CreatePalette", com.STDMETHOD(POINTER(IWICPalette))),
        ("CreateFormatConverter", com.STDMETHOD(POINTER(IWICFormatConverter))),
        ("CreateBitmapScaler", com.STDMETHOD()),
        ("CreateBitmapClipper", com.STDMETHOD()),
        ("CreateBitmapFlipRotator", com.STDMETHOD(POINTER(IWICBitmapFlipRotator))),
        ("CreateStream", com.STDMETHOD(POINTER(IWICStream))),
        ("CreateColorContext", com.STDMETHOD()),
        ("CreateColorTransformer", com.STDMETHOD()),
        (
            "CreateBitmap",
            com.STDMETHOD(
                UINT,
                UINT,
                REFWICPixelFormatGUID,
                WICBitmapCreateCacheOption,
                POINTER(IWICBitmap),
            ),
        ),
        ("CreateBitmapFromSource", com.STDMETHOD()),
        ("CreateBitmapFromSourceRect", com.STDMETHOD()),
        (
            "CreateBitmapFromMemory",
            com.STDMETHOD(
                UINT,
                UINT,
                REFWICPixelFormatGUID,
                UINT,
                UINT,
                POINTER(BYTE),
                POINTER(IWICBitmap),
            ),
        ),
        ("CreateBitmapFromHBITMAP", com.STDMETHOD()),
        ("CreateBitmapFromHICON", com.STDMETHOD()),
        ("CreateComponentEnumerator", com.STDMETHOD()),
        ("CreateFastMetadataEncoderFromDecoder", com.STDMETHOD()),
        ("CreateFastMetadataEncoderFromFrameDecode", com.STDMETHOD()),
        ("CreateQueryWriter", com.STDMETHOD()),
        ("CreateQueryWriterFromReader", com.STDMETHOD()),
    ]


class IWICImagingFactory2(IWICImagingFactory):
    _methods_ = [
        ("CreateImageEncoder", com.STDMETHOD()),
    ]
